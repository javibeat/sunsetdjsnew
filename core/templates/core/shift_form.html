<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    {% load static %}
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <title>Insert Shifts/Events</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- FullCalendar CDN CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />
    <!-- FullCalendar CDN JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <!-- Flatpickr CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>

<body>
    {% include "core/menu.html" %}
    <div class="shiftform-layout">
        <aside class="shiftform-panel">
            <div class="panel-card">
                <h2 style="margin-bottom: 1.2rem;">Insert Shift / Event</h2>
                <form method="post" action="" id="shiftForm">
                    {% csrf_token %}
                    <label for="dj">DJ:</label>
                    <select id="dj" name="dj" required>
                        <option value="">Select DJ</option>
                        {% for dj in djs %}
                            <option value="{{ dj.id }}">{{ dj.name }}</option>
                        {% endfor %}
                    </select>

                    <label for="venue" style="margin-top:1rem;">Venue:</label>
                    <select id="venue" name="venue" required>
                        <option value="">Select Venue</option>
                        <option value="Drift">Drift</option>
                        <option value="Aura">Aura</option>
                        <option value="Azure">Azure</option>
                        <option value="Ammos">Ammos</option>
                    </select>

                    <label for="multidate" style="margin-top:1rem;">Dates:</label>
                    <input type="text" id="multidate" name="dates" placeholder="Select one or more dates" required
                        autocomplete="off">
                    <small style="color:#888; margin-bottom: 0.7rem;">You can select multiple dates from the
                        calendar</small>

                    <div id="time-blocks">
                        <div class="time-block" style="margin-bottom:0.7rem;">
                            <div style="margin-top:0.4rem;">
                                <label>Start Time:</label>
                                <div style="display:flex; gap:0.3rem;">
                                    <select name="start_hour[]">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                    <select name="start_minute[]">
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                    <select name="start_ampm[]">
                                        <option value="am">AM</option>
                                        <option value="pm" selected>PM</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top:0.4rem;">
                                <label>End Time:</label>
                                <div style="display:flex; gap:0.3rem;">
                                    <select name="end_hour[]">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                    <select name="end_minute[]">
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                    <select name="end_ampm[]">
                                        <option value="am">AM</option>
                                        <option value="pm" selected>PM</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="shiftform-remove-btn" onclick="removeTimeBlock(this)"
                                style="margin-top:0.4rem; display:none;">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="shiftform-multishift-btn" onclick="addTimeBlock()"
                        style="margin-top:0.6rem;">Add another time slot</button>
                    <script>
                        function addTimeBlock() {
                            var container = document.getElementById('time-blocks');
                            var blocks = container.getElementsByClassName('time-block');
                            var newBlock = blocks[0].cloneNode(true);
                            // Limpia selects al clonar
                            Array.from(newBlock.querySelectorAll('select')).forEach(sel => sel.selectedIndex = 0);
                            // Muestra botón remove en clones
                            newBlock.querySelector('.shiftform-remove-btn').style.display = 'inline-block';
                            container.appendChild(newBlock);
                        }
                        function removeTimeBlock(btn) {
                            var block = btn.closest('.time-block');
                            var container = document.getElementById('time-blocks');
                            if (container.getElementsByClassName('time-block').length > 1) {
                                block.remove();
                            }
                        }
                    </script>

                    <div style="margin-top:1.2rem;">
                        <input type="checkbox" id="is_event" name="is_event" onchange="toggleEventFields(this)">
                        <label for="is_event">Is Event?</label>
                    </div>

                    <div id="event_fields" style="display:none; margin-top:0.7rem;">
                        <label for="has_dj">Has DJ?</label>
                        <select id="has_dj" name="has_dj">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                        <label for="event_comment" style="margin-top:0.5rem;">Comment:</label>
                        <input type="text" id="event_comment" name="event_comment" placeholder="Event details...">
                    </div>

                    <button type="submit" style="margin-top:1.6rem;">Save Shift/Event</button>
                </form>
                <script>
                    function toggleEventFields(checkbox) {
                        var fields = document.getElementById('event_fields');
                        fields.style.display = checkbox.checked ? 'block' : 'none';
                    }
                </script>
                <!-- DJ Summary Panel Below -->
                <div id="dj-summary-panel"
                     class="panel-card"
                     style="margin-top: 2rem; background-color: #f9f9f9; padding: 1rem; border-radius: 8px;">
                    <h2 style="margin-bottom: 1rem;">DJ Summary</h2>
                    <ol id="dj-summary-list" style="padding-left: 1.5rem; margin: 0;">
                        {% if dj_summary %}
                            {% for item in dj_summary %}
                                <li style="padding: 0.4rem 0; border-bottom: 1px solid #ddd;">
                                    <strong>{{ item.name }}</strong>: {{ item.count }}
                                </li>
                            {% endfor %}
                        {% else %}
                            <li>No shifts available.</li>
                        {% endif %}
                    </ol>
                </div>
            </div>
        </aside>
        <main class="shiftform-calendar">
            <h1>Calendar (Admin)</h1>
            <div id="calendar"></div>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                var shifts = [
                    {% for shift in shifts %}
                    {
                        id: "{{ shift.id }}",
                        title: "{{ shift.dj }} - {{ shift.venue }} ({{ shift.start_time }} - {{ shift.end_time }})",
                        start: "{{ shift.date }}T{{ shift.start_time }}",
                        end: "{{ shift.date }}T{{ shift.end_time }}",
                        dj: "{{ shift.dj }}",
                        backgroundColor: "{{ shift.color }}",
                        textColor: "#ffffff",
                        borderColor: "transparent",
                        is_event: {% if shift.is_event %}true{% else %}false{% endif %}
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ];
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    height: "auto",
                    eventMaxStack: 6,
                    dayMaxEventRows: true,
                    firstDay: 1,
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,listWeek'
                    },
                    events: shifts,
                    eventContent: function(arg) {
                        var customEl = document.createElement('div');
                        customEl.className = 'fc-event-content';
                        customEl.setAttribute('data-dj', arg.event.extendedProps.dj);
                        customEl.style.backgroundColor = arg.event.backgroundColor;
                        customEl.style.color = 'white';
                        customEl.style.padding = '2px 5px';
                        customEl.style.borderRadius = '3px';
                        customEl.innerText = arg.event.title;
                        
                        // Añadir clase especial si es un evento
                        if (arg.event.extendedProps.is_event) {
                            customEl.classList.add('is-event');
                        }
                        
                        return { domNodes: [customEl] };
                    },
                    eventClick: function(info) {
                        const event = info.event;
                        const confirmed = confirm(`Do you want to delete this shift?\n${event.title}`);
                        if (confirmed) {
                            fetch(`/delete_shift/${event.id}/`, {
                                method: 'DELETE',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}',
                                    'Content-Type': 'application/json'
                                }
                            }).then(response => {
                                if (response.ok) {
                                    event.remove(); // elimina el evento del calendario
                                    
                                    // Disparar evento personalizado de eliminación
                                    const djId = event.extendedProps.dj === 'Sin DJ' ? null : '{{ request.session.dj_id }}';
                                    const customEvent = new CustomEvent('shiftRemoved', {
                                        detail: { 
                                            title: event.title, 
                                            djId: djId 
                                        }
                                    });
                                    document.dispatchEvent(customEvent);
                                    console.log("Shift removed event dispatched");
                                } else {
                                    alert('Error deleting shift.');
                                }
                            });
                        }
                    },
                    // Actualizar DJ Summary siempre al cambiar de mes/año
                    datesSet: function(info) {
                        const djSummaryPanel = document.getElementById('dj-summary-panel');
                        if (djSummaryPanel) {
                            fetch('/get_dj_summary/', {
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(resp => {
                                if (!resp.ok) throw new Error("Summary fetch error");
                                return resp.text();
                            })
                            .then(html => {
                                djSummaryPanel.querySelector('ul').outerHTML = html;
                            })
                            .catch(err => {
                                djSummaryPanel.querySelector('ul').innerHTML = '<li>Error loading summary.</li>';
                            });
                        }
                    }
                });
                calendar.render();
            }
        });
    </script>
</body>
<script>
    flatpickr("#multidate", {
        mode: "multiple",
        dateFormat: "Y-m-d",
        minDate: "today",
        altInput: true,
        altFormat: "F j, Y"
    });
</script>

<script>
    document.getElementById('shiftForm').addEventListener('submit', function(e) {
        // No detenemos el envío del formulario, solo añadimos el evento
        const djId = document.getElementById('dj').value;
        const djName = document.getElementById('dj').options[document.getElementById('dj').selectedIndex].text;
        const venue = document.getElementById('venue').value;
        const dates = document.getElementById('multidate').value;
        
        // Crear y disparar el evento personalizado
        const event = new CustomEvent('shiftAdded', {
            detail: { 
                title: `${venue} on ${dates}`, 
                djId: djId 
            }
        });
        document.dispatchEvent(event);
        console.log("Shift added event dispatched");
    });
</script>
<script>
    // Escuchar los eventos y almacenar en localStorage
    document.addEventListener('shiftAdded', function(e) {
        // Almacenar en localStorage para recuperarlo en el dashboard
        localStorage.setItem('shiftAdded', JSON.stringify({
            title: e.detail.title,
            djId: e.detail.djId,
            timestamp: new Date().getTime()
        }));
    });
    
    document.addEventListener('shiftRemoved', function(e) {
        // Almacenar en localStorage para recuperarlo en el dashboard
        localStorage.removeItem('shiftRemoved');
        localStorage.setItem('shiftRemoved', JSON.stringify({
            title: e.detail.title,
            djId: e.detail.djId,
            timestamp: new Date().getTime()
        }));
    });
</script>
</html>